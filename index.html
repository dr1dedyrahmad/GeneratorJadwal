<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generator Jadwal Shift - Aturan Final</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .schedule-table th, .schedule-table td {
            text-align: center;
            padding: 0.5rem 0.25rem;
            border: 1px solid #e5e7eb; /* gray-200 */
            vertical-align: middle;
        }
        .cell-p { background-color: #dcfce7; color: #166534; }
        .cell-s { background-color: #dbeafe; color: #1e40af; }
        .cell-o { background-color: #fee2e2; color: #991b1b; }
        .header-staff { background-color: #fef9c3; }
        .header-crew { background-color: #e0f2fe; }
        .sticky-col { position: sticky; background-color: #f9fafb; }
        .col-date { left: 0; z-index: 20; min-width: 60px; }
        .col-day { left: 60px; z-index: 20; min-width: 80px; }
        .col-delivery { left: 140px; z-index: 20; min-width: 120px; }
        .schedule-table thead th { position: sticky; top: 0; z-index: 30; background-color: #f9fafb; }
        .cell-select {
            -webkit-appearance: none;
            appearance: none;
            background-color: transparent;
            border: none;
            color: inherit;
            width: 100%;
            min-width: 60px;
            padding: 0.25rem;
            padding-right: 1.5rem; /* Space for arrow */
            font-size: 0.875rem;
            font-weight: 700;
            text-align: center;
            text-align-last: center; /* For Firefox */
            cursor: pointer;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='currentColor' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.2rem center;
            background-repeat: no-repeat;
            background-size: 1.2em;
        }
         .cell-select option:disabled {
            background-color: #f3f4f6;
            color: #9ca3af;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 24px;
            height: 24px;
            -webkit-animation: spin 2s linear infinite; /* Safari */
            animation: spin 2s linear infinite;
            display: none; /* Hidden by default */
            margin: auto;
        }
        /* Safari */
        @-webkit-keyframes spin {
          0% { -webkit-transform: rotate(0deg); }
          100% { -webkit-transform: rotate(360deg); }
        }
        @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }

        /* Print-specific styles */
        @media print {
            body {
                background-color: white;
                font-size: 10pt;
            }
            .no-print {
                display: none !important;
            }
            .container {
                padding: 0;
                margin: 0;
                max-width: 100%;
            }
            .bg-white {
                box-shadow: none;
                border: none;
                padding: 0;
            }
            #schedule-container {
                overflow: visible;
            }
            .schedule-table {
                width: 100%;
                border-collapse: collapse;
            }
            .schedule-table th, .schedule-table td {
                border: 1px solid #ccc;
                padding: 4px;
            }
            .sticky-col, .schedule-table thead th {
                position: static !important; /* Remove sticky positioning for print */
            }
            .cell-select {
                -webkit-appearance: none;
                appearance: none;
                border: none;
                background-image: none;
                padding: 0.25rem;
                text-align: center;
                width: 100%;
                background-color: transparent !important;
                color: inherit !important;
            }
            .cell-p, .cell-s, .cell-o {
                -webkit-print-color-adjust: exact; /* Ensures background colors print in Chrome/Safari */
                color-adjust: exact; /* Standard */
            }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-2 sm:p-4 lg:p-8">
        <div class="bg-white p-4 sm:p-6 rounded-xl shadow-lg">
            <div class="text-center mb-6 no-print">
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-900">Generator Jadwal Shift Karyawan</h1>
                <p class="text-gray-500 mt-1">Membuat komposisi shift & jarak libur yang baik.</p>
            </div>

            <div class="py-4 px-2 mb-4 border-y border-gray-200 no-print">
                <details class="mb-4 bg-gray-50 p-3 rounded-lg">
                    <summary class="font-semibold cursor-pointer">Pengaturan Karyawan</summary>
                    <div id="settings-container" class="mt-4 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                        <!-- Pengaturan Karyawan akan di-generate oleh JS -->
                    </div>
                </details>

                <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                    <div class="flex flex-col sm:flex-row items-center gap-4 w-full sm:w-auto">
                        <div class="w-full sm:w-48">
                            <label for="month-select" class="sr-only">Bulan:</label>
                            <select id="month-select" class="block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm"></select>
                        </div>
                        <div class="w-full sm:w-32">
                            <label for="year-select" class="sr-only">Tahun:</label>
                            <select id="year-select" class="mt-1 sm:mt-0 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm"></select>
                        </div>
                    </div>
                    <div class="flex flex-wrap items-center justify-center gap-2">
                        <button id="generate-btn" class="flex-grow w-full sm:w-auto sm:flex-grow-0 bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-indigo-700">Buat Jadwal Baru</button>
                        <button id="shuffle-ps-btn" class="flex-grow w-full sm:w-auto sm:flex-grow-0 bg-blue-500 text-white font-semibold py-2 px-4 rounded-md hover:bg-blue-600">Acak P/S</button>
                        <button id="g-sheet-btn" class="flex-grow sm:flex-grow-0 bg-green-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-green-700 flex items-center justify-center gap-2">
                           <span id="g-sheet-btn-text">Simpan ke G-Sheet</span>
                           <div id="g-sheet-loader" class="loader"></div>
                        </button>
                        <!-- New button for viewing Google Sheet -->
                        <button id="view-g-sheet-btn" class="flex-grow sm:flex-grow-0 bg-teal-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-teal-700">Lihat G-Sheet</button>
                        <button id="history-btn" class="flex-grow sm:flex-grow-0 bg-gray-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-gray-700">History</button>
                        <button id="print-pdf-btn" class="flex-grow sm:flex-grow-0 bg-purple-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-purple-700">Print PDF</button>
                    </div>
                </div>
                <div id="summary-container" class="mt-4 no-print">
                    <h2 class="text-xl font-bold text-gray-800 mb-3 text-center">Ringkasan Jadwal</h2>
                    <div id="summary-grid" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-4"></div>
                </div>
            </div>

            <div id="schedule-container" class="overflow-x-auto">
                <table id="schedule-table" class="min-w-full bg-white border-collapse schedule-table">
                    <thead id="schedule-head"></thead>
                    <tbody id="schedule-body" class="divide-y divide-gray-200">
                        <tr>
                            <td colspan="9" class="text-center py-10 text-gray-500 !border-0">
                                Jadwal belum dibuat.
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div id="history-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50 no-print">
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-1/2 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">History Jadwal</h3>
                <div id="history-list" class="mt-2 px-7 py-3 max-h-96 overflow-y-auto"></div>
                <div class="items-center px-4 py-3">
                    <button id="close-history-btn" class="px-4 py-2 bg-gray-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-600">Tutup</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            let employees = [
                { id: 1, name: 'MALA', role: 'STAFF' }, { id: 2, name: 'DEDY', role: 'STAFF' }, { id: 3, name: 'SEYLA', role: 'STAFF' },
                { id: 4, name: 'ALFIAN', role: 'CREW' }, { id: 5, name: 'DEWI', role: 'CREW' }, { id: 6, name: 'MISBAH', role: 'CREW' },
            ];
            let TARGET_OFF_DAYS = 6;
            const MAX_WORK_STREAK = 5;
            const MIN_WORK_STREAK = 3;
            const specialDates = new Set([1, 16]); // Dates with 2 Staff P and 2 Crew P

            const monthSelect = document.getElementById('month-select');
            const yearSelect = document.getElementById('year-select');
            const generateBtn = document.getElementById('generate-btn');
            const shufflePsBtn = document.getElementById('shuffle-ps-btn');
            const historyBtn = document.getElementById('history-btn');
            const printPdfBtn = document.getElementById('print-pdf-btn');
            const scheduleHead = document.getElementById('schedule-head');
            const scheduleBody = document.getElementById('schedule-body');
            const summaryGrid = document.getElementById('summary-grid');
            const settingsContainer = document.getElementById('settings-container');
            const historyModal = document.getElementById('history-modal');
            const historyList = document.getElementById('history-list');
            const closeHistoryBtn = document.getElementById('close-history-btn');
            const gSheetBtn = document.getElementById('g-sheet-btn');
            const gSheetBtnText = document.getElementById('g-sheet-btn-text');
            const gSheetLoader = document.getElementById('g-sheet-loader');
            const viewGSheetBtn = document.getElementById('view-g-sheet-btn'); // New button element

            let generatedScheduleData = null;
            let scheduleHistory = JSON.parse(localStorage.getItem('scheduleHistory')) || [];
            
            async function saveToGoogleSheet() {
                if (!generatedScheduleData) {
                    alert("Buat jadwal terlebih dahulu!");
                    return;
                }
                const appsScriptUrl = "https://script.google.com/macros/s/AKfycbwxLa-5z801FlK-0aIg_nR39jcdc4ERtbmswIKAGeDDPMV_dqbVcHPxeY3uo8Ci0GlS8g/exec";

                gSheetBtnText.style.display = 'none';
                gSheetLoader.style.display = 'block';
                gSheetBtn.disabled = true;

                const monthName = monthSelect.options[monthSelect.selectedIndex].text.toUpperCase();
                const year = yearSelect.value;
                const sheetTitle = `${monthName} ${year}`;

                const header = ["TANGGAL", "HARI", "KIRIMAN", ...employees.map(e => e.name)];
                const dataRows = [];
                const daysInMonth = new Date(parseInt(year), parseInt(monthSelect.value) + 1, 0).getDate();
                const daysOfWeek = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(year, parseInt(monthSelect.value), day);
                    const dayName = daysOfWeek[date.getDay()];
                    const deliverySelect = document.getElementById(`delivery-day-${day}`);
                    const deliveryStatus = deliverySelect.value === 'ya' ? 'Ya' : '';
                    const row = [day, dayName, deliveryStatus];
                    employees.forEach(e => {
                        row.push(generatedScheduleData[day][e.id] || 'O');
                    });
                    dataRows.push(row);
                }
                const values = [header, ...dataRows];

                const payload = {
                    sheetTitle: sheetTitle,
                    values: values
                };

                try {
                    const response = await fetch(appsScriptUrl, {
                        method: 'POST',
                        mode: 'cors',
                        cache: 'no-cache',
                        headers: {
                            'Content-Type': 'text/plain;charset=utf-8',
                        },
                        body: JSON.stringify(payload),
                    });
                    
                    const result = await response.json();
                    if (result.status === 'sukses') {
                        alert(result.message);
                        saveSchedule(true); // true = silent mode
                    } else {
                        throw new Error(result.message);
                    }

                } catch (err) {
                    alert(`Terjadi error saat menyimpan ke Google Sheet: ${err.message}`);
                    console.error(err);
                } finally {
                    gSheetBtnText.style.display = 'inline';
                    gSheetLoader.style.display = 'none';
                    gSheetBtn.disabled = false;
                }
            }


            function initializeSelectors() {
                const months = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
                const currentMonth = new Date().getMonth();
                months.forEach((month, index) => {
                    const option = new Option(month, index);
                    if (index === currentMonth) option.selected = true;
                    monthSelect.add(option);
                });
                const currentYear = new Date().getFullYear();
                for (let i = currentYear - 2; i <= currentYear + 3; i++) {
                    const option = new Option(i, i);
                    if (i === currentYear) option.selected = true;
                    yearSelect.add(option);
                }
                renderSettings();
                updateSummary(null);
            }
            
            function renderSettings() {
                settingsContainer.innerHTML = `
                    <div>
                        <label for="off-days-select" class="block text-sm font-medium text-gray-700">Jumlah Off</label>
                        <select id="off-days-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm">
                            <option value="4">4</option> <option value="5">5</option> <option value="6" selected>6</option> <option value="7">7</option>
                        </select>
                    </div>
                `;
                employees.forEach(emp => {
                    const div = document.createElement('div');
                    div.innerHTML = `
                        <label for="name-emp-${emp.id}" class="block text-sm font-medium text-gray-700">${emp.role} ${emp.id > 3 ? emp.id - 3 : emp.id}</label>
                        <input type="text" id="name-emp-${emp.id}" value="${emp.name}" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    `;
                    settingsContainer.appendChild(div);
                });
                document.getElementById('off-days-select').value = TARGET_OFF_DAYS;
            }

            function updateConfigFromSettings() {
                TARGET_OFF_DAYS = parseInt(document.getElementById('off-days-select').value);
                employees.forEach(emp => {
                    const input = document.getElementById(`name-emp-${emp.id}`);
                    if (input) emp.name = input.value.toUpperCase();
                });
            }
            
            function getManualOverrides(daysInMonth) {
                const overrides = {};
                for (let day = 1; day <= daysInMonth; day++) {
                    overrides[day] = {};
                    for (const emp of employees) {
                        const select = document.getElementById(`d${day}-e${emp.id}`);
                        if (select && select.value !== 'auto') {
                            overrides[day][emp.id] = select.value;
                        }
                    }
                }
                return overrides;
            }

            function generateSchedule() {
                updateConfigFromSettings();
                const month = parseInt(monthSelect.value);
                const year = parseInt(yearSelect.value);
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                
                let schedule = {};
                let employeeStats = {};
                employees.forEach(e => {
                    employeeStats[e.id] = { offCount: 0, lastOffDay: -5 + Math.floor(Math.random() * 3) };
                    for (let day = 1; day <= daysInMonth; day++) {
                        if (!schedule[day]) schedule[day] = {};
                        schedule[day][e.id] = '-';
                    }
                });

                // Assign 'O' (Off) days
                for (let offRound = 0; offRound < TARGET_OFF_DAYS; offRound++) {
                    const sortedEmployees = [...employees].sort((a, b) => (employeeStats[a.id]?.lastOffDay ?? -10) - (employeeStats[b.id]?.lastOffDay ?? -10));
                    
                    for (const emp of sortedEmployees) {
                        if (employeeStats[emp.id].offCount > offRound) continue;

                        let placedOff = false;
                        
                        // Prioritize placing off days within the allowed work streak
                        const searchStart = employeeStats[emp.id].lastOffDay + MIN_WORK_STREAK + 1;
                        const searchEnd = employeeStats[emp.id].lastOffDay + MAX_WORK_STREAK + 1;

                        const potentialDays = [];
                        for (let i = searchStart; i <= searchEnd; i++) {
                            potentialDays.push(i);
                        }
                        potentialDays.sort(() => Math.random() - 0.5); // Randomize search order

                        // Fallback to any available day if within streak range not possible
                        const fallbackDays = [];
                        for (let i = searchEnd + 1; i <= daysInMonth; i++) {
                            fallbackDays.push(i);
                        }

                        const allSearchDays = [...potentialDays, ...fallbackDays];

                        for (const currentDay of allSearchDays) {
                            if (currentDay < 1 || currentDay > daysInMonth) continue;

                            // Skip special dates for off days
                            if (specialDates.has(currentDay)) continue;
                            // Ensure the slot is not already assigned
                            if (schedule[currentDay][emp.id] !== '-') continue;

                            const offOnDayIds = Object.keys(schedule[currentDay]).filter(id => schedule[currentDay][id] === 'O');
                            const staffOffCount = offOnDayIds.filter(id => employees.find(e => e.id == id)?.role === 'STAFF').length;

                            let canPlace = false;
                            if (emp.role === 'STAFF' && staffOffCount < 1 && offOnDayIds.length < 2) { // Max 1 STAFF off, max 2 total off
                                canPlace = true;
                            } else if (emp.role === 'CREW' && offOnDayIds.length < 2) { // Max 2 total off
                                canPlace = true;
                            }

                            if (canPlace) {
                                schedule[currentDay][emp.id] = 'O';
                                employeeStats[emp.id].offCount++;
                                employeeStats[emp.id].lastOffDay = currentDay;
                                placedOff = true;
                                break; // Move to next employee once off day is placed
                            }
                        }
                    }
                }
                
                // Assign 'P' and 'S' shifts, prioritizing P after O and S before O
                for (const emp of employees) {
                    const workDays = [];
                    for (let day = 1; day <= daysInMonth; day++) {
                        if (schedule[day][emp.id] === '-') workDays.push(day);
                    }
                    
                    const pShiftsNeeded = Math.round(workDays.length / 2);
                    const sShiftsNeeded = workDays.length - pShiftsNeeded;
                    let shiftPool = Array(pShiftsNeeded).fill('P').concat(Array(sShiftsNeeded).fill('S'));
                    
                    // Prioritize P after O and S before O
                    workDays.forEach(day => {
                        if (schedule[day + 1]?.[emp.id] === 'O') {
                            schedule[day][emp.id] = 'P';
                            const pIndex = shiftPool.indexOf('P');
                            if (pIndex > -1) shiftPool.splice(pIndex, 1);
                        }
                        if (schedule[day - 1]?.[emp.id] === 'O') {
                            schedule[day][emp.id] = 'S';
                            const sIndex = shiftPool.indexOf('S');
                            if (sIndex > -1) shiftPool.splice(sIndex, 1);
                        }
                    });

                    // Fill remaining days randomly
                    shiftPool.sort(() => Math.random() - 0.5);
                    workDays.forEach(day => {
                        if(schedule[day][emp.id] === '-') {
                            schedule[day][emp.id] = shiftPool.pop() || 'S'; // Default to S if pool runs out
                        }
                    });
                }
                
                // Balance P/S shifts per day, especially for special dates
                for (let day = 1; day <= daysInMonth; day++) {
                    const working = employees.filter(e => schedule[day][e.id] !== 'O');
                    if (working.length === 0) continue;
                    
                    let pStaffTarget = 1, pCrewTarget = 1;
                    if(specialDates.has(day)) { 
                        pStaffTarget = 2; 
                        pCrewTarget = 2; 
                    }
                    
                    let pStaff = working.filter(e => e.role === 'STAFF' && schedule[day][e.id] === 'P');
                    let sStaff = working.filter(e => e.role === 'STAFF' && schedule[day][e.id] === 'S');
                    let pCrew = working.filter(e => e.role === 'CREW' && schedule[day][e.id] === 'P');
                    let sCrew = working.filter(e => e.role === 'CREW' && schedule[day][e.id] === 'S');

                    // Adjust staff P/S
                    while (pStaff.length > pStaffTarget) sStaff.push(pStaff.splice(Math.floor(Math.random() * pStaff.length), 1)[0]);
                    while (pStaff.length < pStaffTarget && sStaff.length > 0) pStaff.push(sStaff.splice(Math.floor(Math.random() * sStaff.length), 1)[0]);
                    // Adjust crew P/S
                    while (pCrew.length > pCrewTarget) sCrew.push(pCrew.splice(Math.floor(Math.random() * pCrew.length), 1)[0]);
                    while (pCrew.length < pCrewTarget && sCrew.length > 0) pCrew.push(sCrew.splice(Math.floor(Math.random() * sCrew.length), 1)[0]);

                    // Apply changes back to schedule
                    pStaff.forEach(e => schedule[day][e.id] = 'P');
                    sStaff.forEach(e => schedule[day][e.id] = 'S');
                    pCrew.forEach(e => schedule[day][e.id] = 'P');
                    sCrew.forEach(e => schedule[day][e.id] = 'S');
                }

                generatedScheduleData = schedule;
                renderSchedule(schedule, month, year);
                updateSummary(schedule);
            }

            function shufflePsOnly() {
                if (!generatedScheduleData) {
                    alert("Buat jadwal terlebih dahulu!");
                    return;
                }
                const month = parseInt(monthSelect.value);
                const year = parseInt(yearSelect.value);
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                let schedule = getManualOverrides(daysInMonth); // Get current state including manual overrides
                const deliveryStates = {};
                for (let day = 1; day <= daysInMonth; day++) {
                    const select = document.getElementById(`delivery-day-${day}`);
                    if (select) deliveryStates[day] = select.value;
                }
                
                for (const emp of employees) {
                    const workDays = [];
                    let pShifts = 0;
                    let sShifts = 0;
                    for (let day = 1; day <= daysInMonth; day++) {
                        const shift = schedule[day][emp.id];
                        if (shift === 'P' || shift === 'S') {
                            workDays.push(day);
                            if (shift === 'P') pShifts++;
                            else sShifts++;
                        }
                    }
                    
                    let shiftPool = Array(pShifts).fill('P').concat(Array(sShifts).fill('S'));
                    
                    // Reset P/S for days not adjacent to 'O'
                    workDays.forEach(day => {
                        if (schedule[day + 1]?.[emp.id] !== 'O' && schedule[day - 1]?.[emp.id] !== 'O') {
                            schedule[day][emp.id] = '-'; // Mark for reshuffling
                        }
                    });

                    shiftPool.sort(() => Math.random() - 0.5); // Shuffle the pool
                    workDays.forEach(day => {
                        if(schedule[day][emp.id] === '-') {
                            schedule[day][emp.id] = shiftPool.pop() || 'S';
                        }
                    });
                }

                // Re-balance P/S shifts per day after shuffling
                for (let day = 1; day <= daysInMonth; day++) {
                    const working = employees.filter(e => schedule[day][e.id] !== 'O');
                    if (working.length === 0) continue;
                    
                    let pStaffTarget = 1, pCrewTarget = 1;
                    if(specialDates.has(day)) { pStaffTarget = 2; pCrewTarget = 2; }
                    
                    let pStaff = working.filter(e => e.role === 'STAFF' && schedule[day][e.id] === 'P');
                    let sStaff = working.filter(e => e.role === 'STAFF' && schedule[day][e.id] === 'S');
                    let pCrew = working.filter(e => e.role === 'CREW' && schedule[day][e.id] === 'P');
                    let sCrew = working.filter(e => e.role === 'CREW' && schedule[day][e.id] === 'S');

                    // Adjust staff P/S
                    while (pStaff.length > pStaffTarget) sStaff.push(pStaff.splice(Math.floor(Math.random() * pStaff.length), 1)[0]);
                    while (pStaff.length < pStaffTarget && sStaff.length > 0) pStaff.push(sStaff.splice(Math.floor(Math.random() * sStaff.length), 1)[0]);
                    // Adjust crew P/S
                    while (pCrew.length > pCrewTarget) sCrew.push(pCrew.splice(Math.floor(Math.random() * pCrew.length), 1)[0]);
                    while (pCrew.length < pCrewTarget && sCrew.length > 0) pCrew.push(sCrew.splice(Math.floor(Math.random() * sCrew.length), 1)[0]);

                    // Apply changes back to schedule
                    pStaff.forEach(e => schedule[day][e.id] = 'P');
                    sStaff.forEach(e => schedule[day][e.id] = 'S');
                    pCrew.forEach(e => schedule[day][e.id] = 'P');
                    sCrew.forEach(e => schedule[day][e.id] = 'S');
                }

                generatedScheduleData = schedule;
                renderSchedule(schedule, month, year, deliveryStates);
                updateSummary(schedule);
            }

            function calculateStats(schedule) {
                let stats = { p: {}, s: {}, off: {} };
                employees.forEach(e => {
                    stats.p[e.id] = 0;
                    stats.s[e.id] = 0;
                    stats.off[e.id] = 0;
                });
                if (!schedule) return stats;

                for (const day in schedule) {
                    for (const empId in schedule[day]) {
                        const shift = schedule[day][empId];
                        if (shift === 'P') stats.p[empId]++;
                        else if (shift === 'S') stats.s[empId]++;
                        else if (shift === 'O') stats.off[empId]++;
                    }
                }
                return stats;
            }
            
            function updateDeliverySchedule(startDay, daysInMonth) {
                const startSelect = document.getElementById(`delivery-day-${startDay}`);
                if (startSelect.value === 'ya') {
                    let lastStatus = 'ya';
                    for (let day = startDay + 1; day <= daysInMonth; day++) {
                        const currentSelect = document.getElementById(`delivery-day-${day}`);
                        lastStatus = (lastStatus === 'ya' ? 'tidak' : 'ya');
                        currentSelect.value = lastStatus;
                    }
                }
            }

            function updateUIFromDOM() {
                const daysInMonth = new Date(parseInt(yearSelect.value), parseInt(monthSelect.value) + 1, 0).getDate();
                const tempSchedule = getManualOverrides(daysInMonth);
                updateSummary(tempSchedule);

                const stats = calculateStats(tempSchedule);
                employees.forEach(emp => {
                    const isOffLimitReached = stats.off[emp.id] >= TARGET_OFF_DAYS;
                    for (let day = 1; day <= daysInMonth; day++) {
                        const select = document.getElementById(`d${day}-e${emp.id}`);
                        if (select) {
                            const offOption = select.querySelector('option[value="O"]');
                            if (offOption) {
                                // Disable 'O' option if limit is reached and current value is not 'O'
                                offOption.disabled = isOffLimitReached && select.value !== 'O';
                            }
                        }
                    }
                });
            }

            function renderSchedule(schedule, month, year, deliveryStates = {}) {
                scheduleHead.innerHTML = '';
                const headerRow = document.createElement('tr');
                
                headerRow.innerHTML = `
                    <th class="sticky-col col-date">TGL</th>
                    <th class="sticky-col col-day">HARI</th>
                    <th class="sticky-col col-delivery">Jadwal Kiriman</th>
                `;

                employees.forEach(e => {
                    const th = document.createElement('th');
                    th.innerHTML = `${e.name}<br><span class="font-normal text-xs">${e.role}</span>`;
                    th.className = e.role === 'STAFF' ? 'header-staff' : 'header-crew';
                    headerRow.appendChild(th);
                });
                scheduleHead.appendChild(headerRow);

                scheduleBody.innerHTML = '';
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const daysOfWeek = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];

                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(year, month, day);
                    const dayName = daysOfWeek[date.getDay()];
                    const isWeekend = date.getDay() === 0 || date.getDay() === 6;

                    const row = document.createElement('tr');
                    
                    row.innerHTML = `
                        <td class="font-medium sticky-col col-date">${day}</td>
                        <td class="sticky-col col-day ${isWeekend ? 'font-semibold text-red-600' : ''}">${dayName}</td>
                    `;
                    
                    const deliveryCell = document.createElement('td');
                    deliveryCell.className = 'sticky-col col-delivery bg-gray-50';
                    const select = document.createElement('select');
                    select.id = `delivery-day-${day}`;
                    select.className = 'cell-select';
                    select.innerHTML = `<option value="tidak" style="color: red;">Tidak</option><option value="ya" style="color: green;">Ya</option>`;
                    select.value = deliveryStates[day] || (day % 2 !== 0 ? 'ya' : 'tidak'); // Default to 'ya' for odd days, 'tidak' for even
                    select.addEventListener('change', () => updateDeliverySchedule(day, daysInMonth));
                    deliveryCell.appendChild(select);
                    row.appendChild(deliveryCell);
                    
                    employees.forEach(e => {
                        const shift = schedule[day]?.[e.id] || 'O'; // Default to 'O' if not found
                        const cell = document.createElement('td');
                        const shiftSelect = document.createElement('select');
                        shiftSelect.id = `d${day}-e${e.id}`;
                        shiftSelect.className = `cell-select`;
                        shiftSelect.innerHTML = `<option value="P">P</option><option value="S">S</option><option value="O">O</option>`;
                        shiftSelect.value = schedule[day]?.[e.id] ? schedule[day][e.id] : 'P'; // Set value from schedule or default

                        // Function to set cell color based on shift value
                        const setCellColor = (value) => {
                            cell.className = ''; // Clear existing classes
                            if (value === 'P') cell.classList.add('cell-p');
                            else if (value === 'S') cell.classList.add('cell-s');
                            else if (value === 'O') cell.classList.add('cell-o');
                        };

                        setCellColor(shiftSelect.value); // Set initial color
                        shiftSelect.addEventListener('change', () => {
                            setCellColor(shiftSelect.value);
                            updateUIFromDOM(); // Update summary and disabled states on change
                        });

                        cell.appendChild(shiftSelect);
                        row.appendChild(cell);
                    });
                    scheduleBody.appendChild(row);
                }
                updateUIFromDOM(); // Initial update after rendering
            }

            function updateSummary(schedule) {
                summaryGrid.innerHTML = '';
                const stats = calculateStats(schedule);

                employees.forEach(e => {
                    const card = document.createElement('div');
                    card.className = `p-3 rounded-lg shadow-sm border ${!schedule ? 'border-gray-200 bg-gray-50' : 'border-green-300 bg-green-50'}`;
                    card.innerHTML = `
                        <p class="font-bold text-gray-800">${e.name}</p>
                        <p class="text-sm text-gray-600">
                            <span class="font-semibold cell-p px-1 rounded">P: ${stats.p[e.id]}</span>, 
                            <span class="font-semibold cell-s px-1 rounded">S: ${stats.s[e.id]}</span>, 
                            <span class="font-bold text-green-700 cell-o px-1 rounded">O: ${stats.off[e.id]}</span>
                        </p>
                    `;
                    summaryGrid.appendChild(card);
                });
            }
            
            function saveSchedule(isSilent = false) {
                if(!generatedScheduleData) {
                    if (!isSilent) alert('Buat jadwal terlebih dahulu sebelum menyimpan!');
                    return;
                }
                const monthName = monthSelect.options[monthSelect.selectedIndex].text;
                const year = yearSelect.value;
                const timestamp = new Date().toLocaleString('id-ID');
                scheduleHistory.push({
                    name: `Jadwal ${monthName} ${year} (${timestamp})`,
                    data: JSON.parse(JSON.stringify(generatedScheduleData)) // Deep copy
                });
                localStorage.setItem('scheduleHistory', JSON.stringify(scheduleHistory));
                if (!isSilent) alert('Jadwal berhasil disimpan secara lokal!');
            }

            function renderHistory() {
                historyList.innerHTML = '';
                if(scheduleHistory.length === 0) {
                    historyList.innerHTML = '<p class="text-gray-500">Belum ada jadwal yang disimpan.</p>';
                    return;
                }
                scheduleHistory.forEach((item, index) => {
                    const div = document.createElement('div');
                    div.className = 'flex justify-between items-center p-2 border-b';
                    div.innerHTML = `
                        <span>${item.name}</span>
                        <div>
                            <button data-index="${index}" class="load-history-btn px-3 py-1 bg-blue-500 text-white text-sm rounded hover:bg-blue-600">Muat</button>
                            <button data-index="${index}" class="delete-history-btn px-3 py-1 bg-red-500 text-white text-sm rounded hover:bg-red-600">Hapus</button>
                        </div>
                    `;
                    historyList.appendChild(div);
                });
            }

            historyList.addEventListener('click', function(e) {
                if (e.target.classList.contains('load-history-btn')) {
                    const index = parseInt(e.target.dataset.index);
                    const loadedData = scheduleHistory[index].data;
                    generatedScheduleData = loadedData; // Set as current data
                    const month = parseInt(monthSelect.value);
                    const year = parseInt(yearSelect.value);
                    renderSchedule(loadedData, month, year);
                    updateSummary(loadedData);
                    historyModal.classList.add('hidden');
                }
                if (e.target.classList.contains('delete-history-btn')) {
                    const index = parseInt(e.target.dataset.index);
                    const password = prompt("Masukkan password untuk menghapus item ini:");
                    if (password === "1234") { // Simple password for deletion
                        scheduleHistory.splice(index, 1);
                        localStorage.setItem('scheduleHistory', JSON.stringify(scheduleHistory));
                        renderHistory();
                    } else if (password !== null) { // User did not press cancel
                        alert("Password salah!");
                    }
                }
            });
            
            // Event Listeners for buttons
            generateBtn.addEventListener('click', () => generateSchedule());
            shufflePsBtn.addEventListener('click', shufflePsOnly);
            printPdfBtn.addEventListener('click', () => window.print());
            historyBtn.addEventListener('click', () => {
                renderHistory();
                historyModal.classList.remove('hidden');
            });
            closeHistoryBtn.addEventListener('click', () => {
                historyModal.classList.add('hidden');
            });
            gSheetBtn.addEventListener('click', saveToGoogleSheet);
            // New event listener for view Google Sheet button
            viewGSheetBtn.addEventListener('click', () => {
                window.open("https://docs.google.com/spreadsheets/d/1f_daABnjMK4cZsrPISmctsVZDjKYyr0iKmCFfWFbWe0/edit?gid=1432366539#gid=1432366539", "_blank");
            });
            
            initializeSelectors();
        });
    </script>
</body>
</html>
